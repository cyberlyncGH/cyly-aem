#!/bin/bash

# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.

if [ $1 == "on" ]; then
  ENABLED="true"
  ACTION_TYPE="ENABLE"
else
  ENABLED="false"
  ACTION_TYPE="DISABLE"
fi

# The host and port of the source server
SOURCE="localhost:4502"
# The user credentials on the source server (username:password)
SOURCE_CRED="<%= @author_user %>:<%= @author_password %>"

ROOT_PATH="/etc/replication/agents.author"

ALL_PATHS=`curl -s -u $SOURCE_CRED "$SOURCE/bin/querybuilder.json?path=$ROOT_PATH&nodename=publish*&1_property=jcr:content/cq:template&1_property.value=/libs/cq/replication/templates/agent&1_property.operation=like&p.limit=-1" | tr ",[" "\n" | sed 's/ /%20/g' | grep path | awk -F \" '{print $4 "\n"}'`

echo "Found agents to $ACTION_TYPE:"
echo "$ALL_PATHS"

for SINGLE_PATH in $ALL_PATHS
do
echo "$ACTION_TYPE agent $SINGLE_PATH"
out=`curl -H "Accept: application/json" -s -u $SOURCE_CRED -F"enabled=$ENABLED" $SOURCE$SINGLE_PATH/jcr:content`
#check for success
if ! echo $out | grep '"status.message":"OK"' > /dev/null; then
  echo "Failed to $ACTION_TYPE replication agent."
  exit 1
fi	
done