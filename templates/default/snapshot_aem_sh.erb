#!/bin/bash

# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

# If an rsync or snapshot deployment is running, exit
if pgrep rsync_aem.sh
then
  echo "AEM archive job is currently running, exiting..."
  exit 2
fi
if pgrep deploy_snapshot
then
  echo "A snapshot deployment is currently running, exiting..."
  exit 3
fi

echo "###########################"
echo "Starting aem snapshot at `date`. This process may take a considerable amount of time depending on the current amount of content held by AEM."
UNCOMPRESSED_SIZE=`du -sh <%= @source_path %> | awk '{print $1}'`
echo "The current uncompressed size of both the Author and Publish nodes is [${UNCOMPRESSED_SIZE}]."
/usr/bin/rsync -rltD --delete <%= @source_path %>/ <%= @dest_path %>/
exit_code=$?
echo "Finished aem snapshot at `date`"
echo "###########################"
exit $exit_code
